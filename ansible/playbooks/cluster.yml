---
- hosts: master
  gather_facts: yes
  become: yes
  roles:
    - docker
    - kubernetes/master
    - cni

- hosts: nodes
  gather_facts: yes
  become: yes
  roles:
    - docker
    - kubernetes/node

      # - name: Install docker dependencies
      #   become: yes
      #   yum:
      #     name: ['yum-utils', 'device-mapper-persistent-data', 'lvm2']

      # - name: Add docker repository
      #   shell: yum-config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
      #   args:
      #     creates: /etc/yum.repos.d/docker-ce.repo

      # - name: Installs docker
      #   yum: 
      #     name: ['docker-ce', 'docker-ce-cli', 'containerd.io']
      #     state: installed

      # - name: restart docker
      #   systemd: 
      #     name: docker 
      #     state: restarted
      #     daemon_reload: yes
      #     enabled: yes

      # - name: Remove swapfile from /etc/fstab
      #   mount:
      #     name: swap
      #     fstype: swap
      #     state: absent

      # - name: Turn swap off
      #   shell: swapoff -a

      # - name: Put SELinux in permissive mode.
      #   selinux:
      #     policy: targeted
      #     state: permissive

      # - name: Effectively disable SELinux
      #   replace:
      #     path: /etc/selinux/config
      #     regexp: '^SELINUX=enforcing$'
      #     replace: 'SELINUX=permissive'

      # - name: Setup kubernetes.repo
      #   copy:
      #     dest: "/etc/yum.repos.d/kubernetes.repo"
      #     content: |
      #       [kubernetes]
      #       name=Kubernetes
      #       baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
      #       enabled=1
      #       gpgcheck=1
      #       repo_gpgcheck=1
      #       gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

      # - name: Yum repo Update
      #   become: yes
      #   shell: yum update -y

      # - name: Install kubeadm packages
      #   become: yes
      #   yum:
      #     name: ['kubeadm'] 
      #     state: present
        
      # # - name: Detect docker's cgroup-driver
      # #   shell: docker info 2>/dev/null |grep -i cgroup | cut -d":" -f2 | tr -d " "
      # #   register: docker_cgroup_driver

      # - name: modprobe
      #   command: modprobe br_netfilter

      # - name: Add netbridge config ip6
      #   lineinfile:
      #     path: /etc/sysctl.d/k8s.conf
      #     line: 'net.bridge.bridge-nf-call-ip6tables = 1'
      #     state: present
      #     create: yes

      # - name: Add netbridge config ip4
      #   lineinfile:
      #     path: /etc/sysctl.d/k8s.conf
      #     line: 'net.bridge.bridge-nf-call-iptables = 1'
      #     state: present
      #     create: yes

      # - name: Update sysctl
      #   command: sysctl --system

      # - name: Start kubelet
      #   systemd:
      #     state: started
      #     enabled: yes
      #     name: kubelet
